<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Backbone Tutorials</title>
    <link href="../../_assets/main/css/normalize.css" rel="stylesheet" />
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link href="../../_assets/main/css/main.css" rel="stylesheet" />
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
</head>
<body>
    <script src="../../_assets/main/js/libs/jquery-1.11.2.js"></script>
    <script src="../../_assets/main/js/libs/underscore.js"></script>
    <script src="../../_assets/main/js/libs/backbone.js"></script>

    <div class="container">
        <div class="row">
            <table class="table">
                <caption><a href="#">posts</a> /// <a href="#/users">users</a></caption>
                <thead class="posts">
                    <tr>
                        <th>#</th>
                        <th>Title</th>
                        <th>Content</th>
                        <th>Date</th>
                        <th>User ID</th>
                    </tr>
                </thead>
                <thead class="users">
                    <tr>
                        <th>#</th>
                        <th>UserName</th>
                        <th>FullName</th>
                        <th>Password</th>
                        <th>Eposta</th>
                    </tr>
                </thead>
                <tbody id="users"></tbody>
                <tbody id="posts"></tbody>
            </table>
            
            <div id="postDetail">
            </div>   
            
        </div>
    </div>


    <!-- TEMPLATES START -->
    <!-- posts -->
    <script type="text/template" id="postTemp">
        <th scope="row"><%= ID %></th>
        <td>Mark user <%= Title %></td>
        <td>Otto <%= Content %></td>
        <td><%= Date %></td>
        <td><a href="#/post/<%= ID %>">Detay</a></td>
    </script>
    
    <!-- post detail -->
    <script type="text/template" id="postDetailTemp">
        <div> <strong>ID</strong> : <%= ID %></div>
        <div> <strong>Title</strong> : <%= Title %></div>
        <div> <strong>Content</strong> : <%= Content %></div>
        <div> <strong>Date</strong> : <%= Date %></div>
        <div> <a href="#">Geri</a> </div>
    </script>

    <!-- users -->
    <script type="text/template" id="userTemp">
        <th scope="row"><%= ID %></th>
        <td><%= UserName %></td>
        <td><%= FullName %></td>
        <td><%= Password %></td>
        <td><%= Eposta %></td>
    </script>

    <!-- TEMPLATE END -->


    <script type="text/javascript">
        /* model start */

        /* user */
        var User = Backbone.Model.extend({
            defaults: {
                ID: "ID",
                UserName: "UserName",
                FullName: "FullName",
                Password: "Password",
                Eposta: "Eposta"
            }
        });

        /* post */
        var Post = Backbone.Model.extend({
            defaults: {
                ID: "ID",
                Title: "Title",
                Content: "Content",
                Date: "Date",
                UserID: "UserID"
            }
        });

        /* model end */


        /* collection start */

        /* users */
        var Users = Backbone.Collection.extend({
            Model: User
        });

        /* posts */
        var Posts = Backbone.Collection.extend({
            Model: Post
        });

        /* collection end */


        /* view start */

        /* itemView start */

        /* UserItemView */
        var UserItemView = Backbone.View.extend({
            template: _.template($("#userTemp").html(), {}),
            tagName: "tr",
            render: function () {
                this.$el.html(this.template(this.model.attributes));
                return this;
            }
        });

        /* PostItemView */
        var PostItemView = Backbone.View.extend({
            template: _.template($("#postTemp").html(), {}),
            tagName: "tr",
            render: function () {
                this.$el.html(this.template(this.model.attributes));
                return this;
            }
        });
        
        /* PostDetailView */
        var PostDetailView = Backbone.View.extend({
            template: _.template($("#postDetailTemp").html(), {}),
            tagName: "tr",
            render: function () {
                this.$el.html(this.template(this.model.attributes));
                return this;
            }
        });

        /* itemView end */

        /* Collection View Start */

        /* PostCollectionView */
        var PostCollectionView = Backbone.View.extend({
            initialize: function () {
                this.renderAll();
            },
            render: function (model) {
                var postItemView = new PostItemView({ model: model });
                this.$el.append(postItemView.render().el);
            },
            renderAll: function () {
                var _this = this;
                _.each(this.collection.models, function (model) {
                    _this.render(model);
                });
            }
        });

        /* UserCollectionView */
        var UserCollectionView = Backbone.View.extend({
            initialize: function () {
                this.renderAll();
            },
            render: function (model) {
                var userItemView = new UserItemView({ model: model });
                this.$el.append(userItemView.render().el);
            },
            renderAll: function () {
                var _this = this;
                _.each(this.collection.models, function (model) {
                    _this.render(model);
                });
            }
        });
        /* Collection View End */

        /* view end */

        /* appRouter definations */
        var AppRouter = Backbone.Router.extend({
            routes: {
                "" : "getAllPost", // homepage -- tüm post'lar 
                "post/:id": "getPost", // #/post/id -- gelen id'ye göre post goster
                "users": "getAllUsers", // #/users -- tüm user'ler
                "user/:id": "getUser" // #/user/id -- gelen id'ye göre user göster
            },
            getAllUsers: function () {
                /* ajax ile user.json'dan datayı alıp, json'ları model, collection ve collectionview'ı kullanarak ekrana basar */
                $("#users").empty();
                $("#postDetail").empty();
                $(".table thead").hide();
                $(".table thead.users").show();
                
                $.ajax({
                    url: "ajax/user.json",
                    dataType: "json"
                }).complete(function (data) {
                    var users = new Users();
                    _.each(data.responseJSON, function (models) {
                        users.add(new User(models));
                    });
                    var userCollectionView = new UserCollectionView({ el: $("#users"), collection: users });
                });
            },
            getAllPost: function () {
                $("#users").empty();
                $("#postDetail").empty();
                $(".table thead").hide();
                $(".table thead.posts").show();
                
                $.ajax({
                    url: "ajax/post.json",
                    dataType: "json"
                }).complete(function (data) {
                    var users = new Users();
                    _.each(data.responseJSON, function (models) {
                        users.add(new User(models));
                    });
                    var postCollectionView = new PostCollectionView({ el: $("#users"), collection: users })
                });
            },
            getPost: function ( id ) {
                $("#users").empty();
                $("#postDetail").empty();
                $(".table thead").hide();
                    
                $.ajax({
                    url: "ajax/post.json",
                    dataType: "json"
                }).complete(function (data) {
                    _.each(data.responseJSON, function (models) {
                        if (models.ID == id){
                            var postDetailView = new PostDetailView({ el: $("#postDetail"),  model: new User(models) });
                            postDetailView.render();
                        }
                    });
                });
            },
            getUser: function ( id ) {
                $("#users").empty();
                $("#postDetail").empty();
                $(".table thead").hide();
                $(".table thead.users").show();
                
                $.ajax({
                    url: "ajax/user.json",
                    dataType: "json"
                }).complete(function (data) {
                    _.each(data.responseJSON, function (models) {
                        if( models.ID == id ){
                            var userItemView = new UserItemView({ el: $("#users"), model: new User(models) });
                            $("#users").html("<tr>" + userItemView.render().$el.html() + "</tr>" );
                        }
                    });
                });
            }
        });
        /* appRouter definations */
        
        
        var appROuter = new AppRouter;
        Backbone.history.start();

    </script>
</body>
</html>